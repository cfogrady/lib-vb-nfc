package com.github.cfogrady.vbnfc.vb

import com.github.cfogrady.vbnfc.CryptographicTransformer
import com.github.cfogrady.vbnfc.FormatPagedBytes
import com.github.cfogrady.vbnfc.TranslatorTestUtils
import com.github.cfogrady.vbnfc.data.NfcCharacter
import io.mockk.every
import io.mockk.mockkClass
import io.mockk.mockkStatic
import org.junit.Assert
import org.junit.Test
import java.text.Normalizer.Form

class VBNfcDataTranslatorTest {

    companion object {
        @OptIn(ExperimentalStdlibApi::class)
        val BabySlot0_2021_01_06 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b600000000000000000000000d0000000d00000000000000000000000d0000000d000100000000000000000000000000010001000000000000000000000000000101320100000000000000000000003b6f01320100000000000000000000003b6f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff21010623fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000721010600000000042501035c0000000721010600000000042501035c00000300003e00000400000b0000005000000300003e00000400000b0000005000000024122024121124121024120922000000241220241211241210241209222402222402210000000000000000008f2402222402210000000000000000008f".hexToByteArray()
        @OptIn(ExperimentalStdlibApi::class)
        val BabySlot1_2022_02_13 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b600000000000000000001000d0100000f00000000000000000001000d0100000f0001000000000000000000000000000100010000000000000000000000000001015201c000c500000000000000003b14015201c000c500000000000000003b140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100ff00ff00ff00ff21010625220213ffffffffffffffffffffffff2b00ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000452202130000000004250103a9000000452202130000000004250103a900000300003e00000400000b0000005000000300003e00000400000b0000005000000024122024121124121024120922000000241220241211241210241209222402222402210000000000000000008f2402222402210000000000000000008f".hexToByteArray()
        @OptIn(ExperimentalStdlibApi::class)
        val ChildSlot2_2023_03_25 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b600000000000000000002000d0202001300000000000000000002000d02020013000100000000000000000000000000010001000000000000000000000000000101640141017500000000000000003b5801640141017500000000000000003b5800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000200ff00ff00ff21010628220213230325ffffffffffffffffff7900ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000682303250000000004250103e0000000682303250000000004250103e000000300003e00000400000b0000005000000300003e00000400000b0000005000000024122024121124121024120922000000241220241211241210241209222402222402210000000000000000008f2402222402210000000000000000008f".hexToByteArray()
        @OptIn(ExperimentalStdlibApi::class)
        val AdultSlot3_2023_03_26 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b600000000000000000003000d0303001600000000000000000003000d0303001600010000000000000000000000000001000100000000000000000000000000010132013a000000000000000000003ba90132013a000000000000000000003ba9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010002000300ff00ff2101062c220213230325230326ffffffffffffc800ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000772303260000000004250103f0000000772303260000000004250103f000000300003e00000400000b0000005000000300003e00000400000b0000005000000024122024121124121024120922000000241220241211241210241209222402222402210000000000000000008f2402222402210000000000000000008f".hexToByteArray()
        @OptIn(ExperimentalStdlibApi::class)
        val PerfectSlot7_2023_04_26 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b600000000000000000007000d0403001b00000000000000000007000d0403001b000100000000000000000000000000010001000000000000000000000000000101320142000000000000000000003ab001320142000000000000000000003ab00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100020003000700ff21010634220213230325230326230426ffffff1800ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b8230426000000000425010333000001b823042600000000042501033300000300003e00000400000b0000005000000300003e00000400000b0000005000000024122024121124121024120922000000241220241211241210241209222402222402210000000000000000008f2402222402210000000000000000008f".hexToByteArray()
        @OptIn(ExperimentalStdlibApi::class)
        val UltimateSlot13_2023_04_27 = "000000000004745700000000240000f3000000000004745700000000240000f3014000700401000000000000000000b6014000700401000000000000000000b60000000000000000000d000d050201220000000000000000000d000d05020122000100000000000000000000000000010001000000000000000000000000000101590256011000000000000000006e3101590256011000000000000000006e310110000023042600000000000000005e000000000000000000000000000000000000000000000000000000000000000000000001000200030007000d210106422202132303252303262304262304266800ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff00ff00ff00ff00ff22121645fffffffffffffffffffffffffffffff100ff00ff00fffffffffffffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000692304270000000b2523042634000000692304270000000b252304263400000400000300003e00000400000b5400000400000300003e00000400000b540000002501032412202412112412100c0000002501032412202412112412100c2412092402220000000000000000008724120924022200000000000000000087".hexToByteArray()
    }

    @OptIn(ExperimentalStdlibApi::class)
    @Test
    fun testParsing() {
        mockkStatic(android.util.Log::class)
        every { android.util.Log.i(any<String>(), any<String>()) } answers {
            val message = it.invocation.args[1] as String
            println(message)
            1
        }

        // println("Ultimate Date:\n${FormatPagedBytes(UltimateSlot13_2023_04_27)}")

        val testRaw = PerfectSlot7_2023_04_26
        val expectedCharacter = VBNfcCharacter(
            dimId=13u,
            charIndex=7u,
            stage=4,
            attribute=NfcCharacter.Attribute.Vaccine,
            ageInDays=0,
            nextAdventureMissionStage=1,
            mood=50,
            vitalPoints=0u,
            itemEffectMentalStateValue=0,
            itemEffectMentalStateMinutesRemaining=0,
            itemEffectActivityLevelValue=0,
            itemEffectActivityLevelMinutesRemaining=0,
            itemEffectVitalPointsChangeValue=0,
            itemEffectVitalPointsChangeMinutesRemaining=0,
            transformationCountdownInMinutes = 58u,
            injuryStatus=NfcCharacter.InjuryStatus.None,
            trophies=0u,
            currentPhaseBattlesWon=0u,
            currentPhaseBattlesLost=0u,
            totalBattlesWon=0u,
            totalBattlesLost=0u,
            activityLevel=1,
            heartRateCurrent=66u,
            transformationHistory= arrayOf(
                NfcCharacter.Transformation(
                    toCharIndex = 0u,
                    year = 2021u,
                    month = 1u,
                    day = 6u),
                NfcCharacter.Transformation(
                    toCharIndex = 1u,
                    year = 2022u,
                    month = 2u,
                    day = 13u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 2u,
                    year = 2023u,
                    month = 3u,
                    day = 25u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 3u,
                    year = 2023u,
                    month = 3u,
                    day = 26u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 7u,
                    year = 2023u,
                    month = 4u,
                    day = 26u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                )),
            appReserved1= byteArrayOf(0, 0, 0, 0, 0, 4, 116, 87, 0, 0, 0, 0),
            appReserved2= arrayOf(0u, 0u, 0u),
            generation=1u,
            totalTrophies=0u,
        )

        val mockCryptographicTransformer = mockkClass(CryptographicTransformer::class)
        val translator = VBNfcDataTranslator(mockCryptographicTransformer)
        val character = translator.parseNfcCharacter(testRaw)
        Assert.assertEquals(expectedCharacter, character)
        println("Parsed Character: $character")
    }

    @Test
    fun testFormatting() {
        val testCharacter = VBNfcCharacter(
            dimId=13u,
            charIndex=7u,
            stage=4,
            attribute=NfcCharacter.Attribute.Vaccine,
            ageInDays=0,
            nextAdventureMissionStage=1,
            mood=50,
            vitalPoints=0u,
            itemEffectMentalStateValue=0,
            itemEffectMentalStateMinutesRemaining=0,
            itemEffectActivityLevelValue=0,
            itemEffectActivityLevelMinutesRemaining=0,
            itemEffectVitalPointsChangeValue=0,
            itemEffectVitalPointsChangeMinutesRemaining=0,
            transformationCountdownInMinutes = 58u,
            injuryStatus=NfcCharacter.InjuryStatus.None,
            trophies=0u,
            currentPhaseBattlesWon=0u,
            currentPhaseBattlesLost=0u,
            totalBattlesWon=0u,
            totalBattlesLost=0u,
            activityLevel=1,
            heartRateCurrent=66u,
            transformationHistory= arrayOf(
                NfcCharacter.Transformation(
                    toCharIndex = 0u,
                    year = 2021u,
                    month = 1u,
                    day = 6u),
                NfcCharacter.Transformation(
                    toCharIndex = 1u,
                    year = 2022u,
                    month = 2u,
                    day = 13u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 2u,
                    year = 2023u,
                    month = 3u,
                    day = 25u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 3u,
                    year = 2023u,
                    month = 3u,
                    day = 26u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = 7u,
                    year = 2023u,
                    month = 4u,
                    day = 26u
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                ),
                NfcCharacter.Transformation(
                    toCharIndex = UByte.MAX_VALUE,
                    year = UShort.MAX_VALUE,
                    month = UByte.MAX_VALUE,
                    day = UByte.MAX_VALUE
                )),
            appReserved1= byteArrayOf(0, 0, 0, 0, 0, 4, 116, 87, 0, 0, 0, 0),
            appReserved2= arrayOf(0u, 0u, 0u),
            generation=1u,
            totalTrophies=0u,
        )
        val mockCryptographicTransformer = mockkClass(CryptographicTransformer::class)
        val translator = VBNfcDataTranslator(mockCryptographicTransformer)
        val bytesToOverwrite = PerfectSlot7_2023_04_26.copyOf()
        translator.setCharacterInByteArray(testCharacter, bytesToOverwrite)
        TranslatorTestUtils.assertAllBlocksAreEqual("Data Set", PerfectSlot7_2023_04_26, bytesToOverwrite)
    }
}